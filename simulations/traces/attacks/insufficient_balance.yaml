# Insufficient Balance Attack Trace
# Consumer attempts to lock more funds than they have.
# Expected: Lock should be rejected by witnesses.

name: "insufficient_balance"
description: "Consumer tries to lock 150 units but only has 100"

network:
  seed: 42
  nodes:
    - id: consumer
      region: north_america
      connection: cable
    - id: provider
      region: north_america
      connection: datacenter
    - id: witness_0
      region: north_america
      connection: fiber
    - id: witness_1
      region: europe
      connection: fiber
    - id: witness_2
      region: europe
      connection: datacenter
    - id: witness_3
      region: asia
      connection: fiber
    - id: witness_4
      region: asia
      connection: cable

setup:
  chains:
    consumer:
      balance: 100.0  # Only 100 units available
      trust: 1.0
    provider:
      balance: 50.0
      trust: 2.0
    witness_0:
      trust: 2.0
    witness_1:
      trust: 2.0
    witness_2:
      trust: 2.5
    witness_3:
      trust: 1.5
    witness_4:
      trust: 2.0

  relationships:
    - peers: [consumer, provider]
      age_days: 30
    - peers: [witness_0, witness_1, witness_2, witness_3, witness_4, provider]
      age_days: 100

actions:
  # Consumer tries to lock 150 units (more than their 100 balance)
  - time: 0.0
    actor: consumer
    action: initiate_lock
    params:
      provider: provider
      amount: 150.0  # Attempting to lock more than balance
      session_id: "session_insufficient"

  # Provider receives and selects witnesses
  - time: 0.1
    actor: provider
    action: select_witnesses
    params:
      session_id: "session_insufficient"
      witnesses: [witness_0, witness_1, witness_2, witness_3, witness_4]

  - time: 0.2
    actor: provider
    action: send_witness_commitment
    params:
      session_id: "session_insufficient"
      consumer: consumer

  # Consumer sends witness requests
  - time: 0.5
    actor: consumer
    action: send_witness_requests
    params:
      session_id: "session_insufficient"
      witnesses: [witness_0, witness_1, witness_2, witness_3, witness_4]

  # Witnesses vote (should reject due to insufficient balance)
  - time: 1.0
    actor: witness_0
    action: vote
    params:
      session_id: "session_insufficient"
      verdict: reject  # Should reject

  - time: 1.1
    actor: witness_1
    action: vote
    params:
      session_id: "session_insufficient"
      verdict: reject

  - time: 1.2
    actor: witness_2
    action: vote
    params:
      session_id: "session_insufficient"
      verdict: reject

  - time: 1.3
    actor: witness_3
    action: vote
    params:
      session_id: "session_insufficient"
      verdict: reject

  - time: 1.4
    actor: witness_4
    action: vote
    params:
      session_id: "session_insufficient"
      verdict: reject

assertions:
  - type: lock_failed
    description: "Lock should fail due to insufficient balance"
    session_id: "session_insufficient"

  - type: consumer_state
    description: "Consumer should be in FAILED state"
    consumer: consumer
    expected_state: FAILED
